# 개발 작업 방식 및 가이드라인

## 데이터베이스 스키마 변경 작업

### ⚠️ 필수 원칙

1. **항상 마이그레이션을 고려하라**
   - 새로운 테이블/컬럼 추가 시 기존 데이터가 있을 수 있음
   - 신규 설치용 SQL과 마이그레이션 SQL을 **반드시 분리**

2. **SQL 파일 구조**
   ```
   .doc/sql/
   ├── init-auth-system.sql           # 신규 설치용 (통합)
   ├── migration-001-*.sql            # 마이그레이션용
   ├── migration-002-*.sql            # 다음 마이그레이션
   └── ...
   ```

3. **파일 명명 규칙**
   - 신규 설치: `init-{기능명}.sql`
   - 마이그레이션: `migration-{번호}-{간단한설명}.sql`
   - 예: `migration-001-pending-user-role.sql`

### 스키마 변경 작업 순서

#### 1단계: 마이그레이션 필요성 확인
```
질문: 기존 운영 중인 데이터베이스가 있는가?
├─ YES → 마이그레이션 SQL 작성 필요
└─ NO → 신규 설치 SQL만 작성
```

#### 2단계: SQL 파일 작성

**신규 설치용 (`init-*.sql`)**:
- 모든 초기 세팅을 한 파일에 통합
- PART 1, PART 2... 로 섹션 구분
- 주석으로 각 단계 설명
- 검증 쿼리 포함

**마이그레이션용 (`migration-*.sql`)**:
- 백업 안내 포함
- BEGIN/COMMIT으로 트랜잭션 구분
- 각 단계별 검증 쿼리 포함
- 롤백 스크립트 주석으로 포함
- 실행 전/후 상태 확인 쿼리 포함

#### 3단계: 마이그레이션 가이드 문서 작성

`.doc/migration-guide.md`에 다음 내용 포함:
- [ ] 마이그레이션 목적 및 영향 범위
- [ ] 백업 방법
- [ ] 단계별 실행 방법
- [ ] 검증 방법
- [ ] 롤백 방법
- [ ] 트러블슈팅
- [ ] 체크리스트

#### 4단계: 테스트
1. 로컬 개발 환경에서 테스트
2. 스테이징 환경에서 테스트 (가능하면)
3. 롤백 스크립트 테스트

#### 5단계: 문서화
- `authentication-flow.md` 등 관련 문서 업데이트
- 변경 이력 기록
- README에 마이그레이션 안내 추가

## SQL 파일 작성 가이드

### 기본 구조

```sql
-- ============================================
-- [신규설치/마이그레이션]: 작업 설명
-- 작성일: YYYY-MM-DD
-- 설명: 상세 설명
-- ============================================

-- [신규 설치인 경우]
-- ⚠️ 주의: 이 스크립트는 신규 설치용입니다!
-- 이미 운영 중인 데이터베이스에는 migration-*.sql을 사용하세요.

-- [마이그레이션인 경우]
-- ⚠️ 주의사항
-- 1. 반드시 백업을 먼저 생성하세요!
-- 2. 개발 환경에서 먼저 테스트하세요
-- 3. 각 단계를 하나씩 실행하세요 (전체 실행 X)

-- ========================================
-- Step 1: 제목
-- ========================================
BEGIN;

-- SQL 실행

-- 검증
SELECT ...;

COMMIT;

-- ========================================
-- 롤백 방법 (마이그레이션만)
-- ========================================
/*
BEGIN;
-- 롤백 SQL
COMMIT;
*/
```

### 주석 작성 규칙

1. **섹션 구분**
   ```sql
   -- ========================================
   -- PART 1: 역할 설정
   -- ========================================
   ```

2. **단계별 설명**
   ```sql
   -- 1-1. 기본 역할 생성
   -- 1-2. 역할 확인
   ```

3. **중요 주의사항**
   ```sql
   -- ⚠️ 주의: 백업 필수!
   -- ⚠️ 롤백 시 데이터 손실 가능
   ```

4. **다음 단계 안내**
   ```sql
   -- 다음 단계:
   -- 1. 이메일 템플릿 설정
   -- 2. SMTP 설정
   ```

## 파일 정리 원칙

### SQL 파일

**통합 대상**:
- 같은 기능의 여러 SQL 파일
- 순차적으로 실행해야 하는 스크립트들
- 서로 의존성이 있는 스크립트들

**분리 유지**:
- 신규 설치 vs 마이그레이션
- 서로 다른 기능 영역
- 독립적으로 실행 가능한 스크립트

### 문서 파일

**통합 대상**:
- 중복된 내용
- 서로 참조가 많은 문서
- 같은 주제의 짧은 문서들

**분리 유지**:
- 서로 다른 목적 (설계 vs 가이드 vs API 명세)
- 길이가 긴 문서 (5000줄 이상)
- 자주 참조되는 독립 문서

## 자주 하는 실수

### ❌ 하지 말 것

1. **마이그레이션 없이 스키마 변경**
   ```sql
   -- 나쁜 예: 기존 테이블에 컬럼 추가만 하고 끝
   ALTER TABLE members ADD COLUMN new_field VARCHAR;
   ```

   **문제**: 기존 데이터 처리 방법이 없음

2. **SQL 파일 난립**
   ```
   .doc/sql/
   ├── create-table-1.sql
   ├── create-table-2.sql
   ├── create-trigger-1.sql
   ├── create-trigger-2.sql
   └── ... (20개 파일)
   ```

   **문제**: 실행 순서를 알 수 없음, 관리 불가

3. **검증 쿼리 없음**
   ```sql
   INSERT INTO roles VALUES (...);
   -- 끝
   ```

   **문제**: 제대로 실행되었는지 확인할 수 없음

4. **롤백 계획 없음**

   **문제**: 문제 발생 시 복구 불가

### ✅ 올바른 방법

1. **마이그레이션 포함**
   ```sql
   -- migration-001-add-new-field.sql
   BEGIN;

   -- 컬럼 추가
   ALTER TABLE members ADD COLUMN new_field VARCHAR;

   -- 기존 데이터 업데이트
   UPDATE members SET new_field = 'default' WHERE new_field IS NULL;

   -- 검증
   SELECT COUNT(*) FROM members WHERE new_field IS NULL; -- 0이어야 함

   COMMIT;
   ```

2. **통합된 SQL 파일**
   ```
   .doc/sql/
   ├── init-auth-system.sql          # 모든 초기 세팅
   ├── migration-001-*.sql           # 첫 번째 변경
   └── migration-002-*.sql           # 두 번째 변경
   ```

3. **검증 쿼리 포함**
   ```sql
   -- 실행 전 상태 확인
   SELECT COUNT(*) FROM members WHERE role_id IS NULL;

   -- 업데이트
   UPDATE ...;

   -- 실행 후 상태 확인
   SELECT COUNT(*) FROM members WHERE role_id IS NULL; -- 0이어야 함
   ```

4. **롤백 계획**
   ```sql
   -- ========================================
   -- 롤백 방법
   -- ========================================
   /*
   BEGIN;
   UPDATE members SET new_field = NULL;
   ALTER TABLE members DROP COLUMN new_field;
   COMMIT;
   */
   ```

## 체크리스트

스키마 변경 작업 시 확인사항:

### 작업 전
- [ ] 기존 운영 데이터가 있는지 확인
- [ ] 마이그레이션이 필요한지 판단
- [ ] 백업 계획 수립
- [ ] 롤백 계획 수립

### SQL 작성
- [ ] 신규 설치용 SQL 작성 (init-*.sql)
- [ ] 마이그레이션 SQL 작성 (필요시)
- [ ] 각 단계에 검증 쿼리 포함
- [ ] 롤백 스크립트 포함 (마이그레이션)
- [ ] 주석으로 목적 및 주의사항 명시

### 문서화
- [ ] migration-guide.md 업데이트
- [ ] 관련 설계 문서 업데이트
- [ ] README 업데이트 (필요시)
- [ ] CHANGELOG 업데이트 (필요시)

### 테스트
- [ ] 로컬 환경 테스트
- [ ] 스테이징 환경 테스트 (가능하면)
- [ ] 롤백 스크립트 테스트
- [ ] 프론트엔드 연동 테스트

### 배포
- [ ] 백업 생성
- [ ] 마이그레이션 실행
- [ ] 검증
- [ ] 프론트엔드 배포
- [ ] 최종 동작 확인

## 참고 문서

- `.doc/migration-guide.md` - 마이그레이션 가이드
- `.doc/sql/init-auth-system.sql` - 신규 설치 예시
- `.doc/sql/migration-001-*.sql` - 마이그레이션 예시
