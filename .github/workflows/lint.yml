name: Lint Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Run Biome Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        id: lint
        run: |
          # ë¦°íŠ¸ ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (JSON í¬ë§·)
          pnpm biome check --json . > lint-result.json 2>&1 || true

          # ì¼ë°˜ í¬ë§·ìœ¼ë¡œë„ ì €ì¥ (ì—ëŸ¬ ë©”ì‹œì§€ìš©)
          pnpm biome check . > lint-output.txt 2>&1 || true

          # ë¦°íŠ¸ ì‹¤í–‰ (ì‹¤ì œ ì²´í¬ - ì‹¤íŒ¨ ì‹œ exit code ë°˜í™˜)
          pnpm lint

      - name: Comment PR with lint errors
        if: failure() && steps.lint.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // lint-output.txt íŒŒì¼ ì½ê¸°
            let lintOutput = '';
            try {
              lintOutput = fs.readFileSync('lint-output.txt', 'utf8');
            } catch (error) {
              lintOutput = 'ë¦°íŠ¸ ê²°ê³¼ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }

            // ë¦°íŠ¸ ê²°ê³¼ê°€ ë„ˆë¬´ ê¸¸ë©´ truncate
            const maxLength = 60000; // GitHub ì½”ë©˜íŠ¸ ì œí•œ
            if (lintOutput.length > maxLength) {
              lintOutput = lintOutput.substring(0, maxLength) + '\n\n...(ê²°ê³¼ê°€ ë„ˆë¬´ ê¸¸ì–´ ì¼ë¶€ë§Œ í‘œì‹œë©ë‹ˆë‹¤)';
            }

            // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## ğŸš¨ Lint Check Failed')
            );

            const commentBody = `## ğŸš¨ Lint Check Failed

**Commit**: ${context.sha.substring(0, 7)}
**Action Run**: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})

ë¦°íŠ¸ ê²€ì‚¬ì—ì„œ ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”.

### ì˜¤ë¥˜ ë‚´ìš©

\`\`\`
${lintOutput}
\`\`\`

### ë¡œì»¬ì—ì„œ ìˆ˜ì •í•˜ëŠ” ë°©ë²•

\`\`\`bash
# ë¦°íŠ¸ ì˜¤ë¥˜ í™•ì¸
pnpm lint

# ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ ì˜¤ë¥˜ ìˆ˜ì •
pnpm lint:fix
\`\`\`

---
*ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }

      - name: Comment PR on success
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ê¸°ì¡´ ì‹¤íŒ¨ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## ğŸš¨ Lint Check Failed')
            );

            // ì„±ê³µ ì½”ë©˜íŠ¸
            const successBody = `## âœ… Lint Check Passed

**Commit**: ${context.sha.substring(0, 7)}
**Action Run**: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})

ëª¨ë“  ë¦°íŠ¸ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤! ğŸ‰

---
*ì´ ì½”ë©˜íŠ¸ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

            if (botComment) {
              // ê¸°ì¡´ ì‹¤íŒ¨ ì½”ë©˜íŠ¸ë¥¼ ì„±ê³µ ë©”ì‹œì§€ë¡œ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: successBody,
              });
            } else {
              // ìƒˆ ì„±ê³µ ì½”ë©˜íŠ¸ ìƒì„± (ì²« ì‹¤í–‰ì¸ ê²½ìš°)
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: successBody,
              });
            }
